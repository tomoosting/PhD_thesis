#!/bin/bash
#SBATCH -a 115001,115002,115003,115004,118004,118012,118013,118017,118018,118020,118141,118142,118143,118144,118145,118146,118148,118149,118150,118151,118152,118153,118154,118155,118160,118161,118162,118163,118165,118166,118167,118168,118169,118170,118171,118172,118174,118175,118176,118177,118178,118179,118180,118181,118182,118183,118184,118185,118186,118187,118189,118190,118191,118192,118193,118194,118195,118197,118198,118221,118222,118223,118238,118245,118358,118359,118361,118367,118373,118374,118379,118380,118381,118383,118386,118389,118392,118394,118396,118405,118425,118432,118433,118434,118440,118442,118444,118446,118447,118448,118450,118452,118453,118455,118457,118458,118459,118461,118462,118463,118464,118465,118466,118467,118468,118469,118470,118471,118472,118474,118476,118477,118480,118481,118483,118484,118486,118487,118489,118490,118492,118493,118494,118495,118496,118497,118498,118499,118501,118502,118506,118507,118508,118509,118515,118517,118518,118519,118525,118526,118527,118537,118538,118540,118551,118552,119003,119004,119005,119008,119016,119027,119028,119045,119048,119052,119053,119054,119055,119057,218002,218004,218005,218006,218007,218008,218009,218011,218012,218013,218014,218015,218016,218017,218018,218019,218020,218021,218022,218023,219001,219003,219005,219006,219008,219009,219011,219016,219020,219023,219027,219028,219030,219037,219038,219042,219044,219045,219047,219049,219053,219057,219058,219059,219060,219061,219062,219064,219065,219068,219069,219070,219074,219077,219078,715001,715002,715003,715004,719001,719004,719005,719012,719015,719018,719019,719027,719029,719030,719031,719033,719038,719039,719040,719041,719046,719050,719051,719056,719057,719074,719075,719082,719085,719090,719094,719098,719099,719102,719103,719104,719105,719107,719111,719114,719115,719122,719123,719124,719127,719129,719131,719134,719136,719139,719144,719149,815001,815002,815003,815004,818007,818011,818013,818015,818017,818019,818022,818027,818044,818051,818052,818053,818054,818055,818056,818057,818058,818059,818060,818062,818065,818066,818068,818070,818071,818074,818075,818077,818083,818084,818088,818089,818097,818099,818105,819001,819002,819004,819006,819011,819012,819013,819015,819020,819025,819028,819031,819033,819035,819037,819042,819045,819049,819050,819053,819054,819055,819059,819060,819062,819065,819069,819071,819073,819074,819075,819076,819077,819079,819080,819082,819083,819085,819086,819087,819088,819103,819105,819107
#SBATCH --cpus-per-task=2
#SBATCH --mem-per-cpu=4G
#SBATCH --time=0-1:00
#SBATCH --partition=quicktest
#SBATCH --mail-type=END
#SBATCH --job-name=vcf2fasta_modern
#SBATCH -o /nfs/scratch/oostinto/stdout/vcf2fasta_modern_%A_%a.out
#SBATCH -e /nfs/scratch/oostinto/stdout/vcf2fasta_modern_%A_%a.err
#SBATCH --mail-user=tom.oosting@vuw.ac.nz

module load gatk/4.1.4.1 	# you need 4.1.0.0 or higher to run fasta tool
module load vcftools/0.1.16
module load htslib/1.9
module load bcftools/1.9

set=$1
read_dir=/nfs/scratch/oostinto/call_sets/mitogenomes/vcf
out_dir=/nfs/scratch/oostinto/call_sets/mitogenomes/fasta/$set
ref=/nfs/scratch/oostinto/genome/snapper_mtgenome.fasta
sample=CA${SLURM_ARRAY_TASK_ID}

echo "$sample" > $out_dir/$sample.list

#Select_individual_VCF
vcftools --gzvcf $read_dir/${set}_mito.GQ.HF.vcf.gz	\
--keep $out_dir/$sample.list						\
--recode --recode-INFO-all 							\
--out $out_dir/$sample

##Change missing sites to N and set this as alternative allele
awk '{if ($10 ~ "\\.:" ) {print $1"\t"$2"\t"$3"\t"$4"\t""N""\t"$6"\t"$7"\t"$8"\t"$9"\t"$10} else {print $0}}' $out_dir/$sample.recode.vcf | sed 's/GT:AD:DP:GQ:PL\t\./GT:AD:DP:GQ:PL\t1/g' > $out_dir/$sample.temp.vcf

#Output alternative and missing alleles only
vcftools --vcf $out_dir/$sample.temp.vcf --non-ref-ac 1 --recode --recode-INFO-all --out $out_dir/$sample.alternative
gatk IndexFeatureFile -I $out_dir/$sample.alternative.recode.vcf

gatk FastaAlternateReferenceMaker 				\
	-R $ref										\
	-O $out_dir/$sample.fasta					\
	-V $out_dir/$sample.alternative.recode.vcf	\

#change sample name in fasta file and correct file extension
echo ">$sample" > $out_dir/$sample.fa
tail -n +2 $out_dir/$sample.fasta >> $out_dir/$sample.fa
rm $out_dir/$sample.fasta
mv $out_dir/$sample.fa $out_dir/$sample.fasta 

#clean up 
rm $out_dir/$sample.list
rm $out_dir/$sample.dict
rm $out_dir/$sample.fasta.fai
rm $out_dir/$sample.recode.vcf
rm $out_dir/$sample.temp.vcf
rm $out_dir/$sample.alternative.recode.vcf
rm $out_dir/$sample.alternative.recode.vcf.idx

#SBATCH -a 115001,115002,115003,115004,118004,118012,118013,118017,118018,118020,118141,118142,118143,118144,118145,118146,118148,118149,118150,118151,118152,118153,118154,118155,118160,118161,118162,118163,118165,118166,118167,118168,118169,118170,118171,118172,118174,118175,118176,118177,118178,118179,118180,118181,118182,118183,118184,118185,118186,118187,118189,118190,118191,118192,118193,118194,118195,118197,118198,118221,118222,118223,118238,118245,118358,118359,118361,118367,118373,118374,118379,118380,118381,118383,118386,118389,118392,118394,118396,118405,118425,118432,118433,118434,118440,118442,118444,118446,118447,118448,118450,118452,118453,118455,118457,118458,118459,118461,118462,118463,118464,118465,118466,118467,118468,118469,118470,118471,118472,118474,118476,118477,118480,118481,118483,118484,118486,118487,118489,118490,118492,118493,118494,118495,118496,118497,118498,118499,118501,118502,118506,118507,118508,118509,118515,118517,118518,118519,118525,118526,118527,118537,118538,118540,118551,118552,119003,119004,119005,119008,119016,119027,119028,119045,119048,119052,119053,119054,119055,119057,218002,218004,218005,218006,218007,218008,218009,218011,218012,218013,218014,218015,218016,218017,218018,218019,218020,218021,218022,218023,219001,219003,219005,219006,219008,219009,219011,219016,219020,219023,219027,219028,219030,219037,219038,219042,219044,219045,219047,219049,219053,219057,219058,219059,219060,219061,219062,219064,219065,219068,219069,219070,219074,219077,219078,715001,715002,715003,715004,719001,719004,719005,719012,719015,719018,719019,719027,719029,719030,719031,719033,719038,719039,719040,719041,719046,719050,719051,719056,719057,719074,719075,719082,719085,719090,719094,719098,719099,719102,719103,719104,719105,719107,719111,719114,719115,719122,719123,719124,719127,719129,719131,719134,719136,719139,719144,719149,815001,815002,815003,815004,818007,818011,818013,818015,818017,818019,818022,818027,818044,818051,818052,818053,818054,818055,818056,818057,818058,818059,818060,818062,818065,818066,818068,818070,818071,818074,818075,818077,818083,818084,818088,818089,818097,818099,818105,819001,819002,819004,819006,819011,819012,819013,819015,819020,819025,819028,819031,819033,819035,819037,819042,819045,819049,819050,819053,819054,819055,819059,819060,819062,819065,819069,819071,819073,819074,819075,819076,819077,819079,819080,819082,819083,819085,819086,819087,819088,819103,819105,819107




#SBATCH -a 10,103,106,107,108,14,15,16,44,45,48,49,65,71,72,73,77,82,83,84,89,9,90,91,98,99
#SBATCH -a 115001,115002,115003,115004,118004,118012,118013,118017,118018,118020,118141,118142,118143,118144,118145,118146,118148,118149,118150,118151,118152,118153,118154,118155,118160,118161,118162,118163,118165,118166,118167,118168,118169,118170,118171,118172,118174,118175,118176,118177,118178,118179,118180,118181,118182,118183,118184,118185,118186,118187,118189,118190,118191,118192,118193,118194,118195,118197,118198,118221,118222,118223,118238,118245,118358,118359,118361,118367,118373,118374,118379,118380,118381,118383,118386,118389,118392,118394,118396,118405,118425,118432,118433,118434,118440,118442,118444,118446,118447,118448,118450,118452,118453,118455,118457,118458,118459,118461,118462,118463,118464,118465,118466,118467,118468,118469,118470,118471,118472,118474,118476,118477,118480,118481,118483,118484,118486,118487,118489,118490,118492,118493,118494,118495,118496,118497,118498,118499,118501,118502,118506,118507,118508,118509,118515,118517,118518,118519,118525,118526,118527,118537,118538,118540,118551,118552,119003,119004,119005,119008,119016,119027,119028,119045,119048,119052,119053,119054,119055,119057,218002,218004,218005,218006,218007,218008,218009,218011,218012,218013,218014,218015,218016,218017,218018,218019,218020,218021,218022,218023,219001,219003,219005,219006,219008,219009,219011,219016,219020,219023,219027,219028,219030,219037,219038,219042,219044,219045,219047,219049,219053,219057,219058,219059,219060,219061,219062,219064,219065,219068,219069,219070,219074,219077,219078,715001,715002,715003,715004,719001,719004,719005,719012,719015,719018,719019,719027,719029,719030,719031,719033,719038,719039,719040,719041,719046,719050,719051,719056,719057,719074,719075,719082,719085,719090,719094,719098,719099,719102,719103,719104,719105,719107,719111,719114,719115,719122,719123,719124,719127,719129,719131,719134,719136,719139,719144,719149,815001,815002,815003,815004,818007,818011,818013,818015,818017,818019,818022,818027,818044,818051,818052,818053,818054,818055,818056,818057,818058,818059,818060,818062,818065,818066,818068,818070,818071,818074,818075,818077,818083,818084,818088,818089,818097,818099,818105,819001,819002,819004,819006,819011,819012,819013,819015,819020,819025,819028,819031,819033,819035,819037,819042,819045,819049,819050,819053,819054,819055,819059,819060,819062,819065,819069,819071,819073,819074,819075,819076,819077,819079,819080,819082,819083,819085,819086,819087,819088


